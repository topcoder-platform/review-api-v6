// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model scorecard {
  id            String @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  status        ScorecardStatus
  type          ScorecardType
  challengeTrack ChallengeTrack
  challengeType String
  name          String
  version       String
  minScore      Float
  maxScore      Float
  createdAt     DateTime @default(now())
  createdBy     String
  updatedAt     DateTime @updatedAt
  updatedBy     String

  scorecardGroups scorecardGroup[]
  reviews         review[]

  // Indexes for faster searches
  @@index([challengeTrack])
  @@index([challengeType])
  @@index([name])
}

enum ScorecardStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum ScorecardType {
  SCREENING
  REVIEW
  APPROVAL
  POST_MORTEM
  SPECIFICATION_REVIEW
  CHECKPOINT_SCREENING
  CHECKPOINT_REVIEW
  ITERATIVE_REVIEW
}

enum ChallengeTrack {
  DEVELOPMENT
  DATA_SCIENCE
  DESIGN
  QUALITY_ASSURANCE
}

model scorecardGroup {
  id          String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  scorecardId String
  name        String
  weight      Float
  sortOrder   Int
  createdAt   DateTime @default(now())
  createdBy   String
  updatedAt   DateTime @updatedAt
  updatedBy   String

  scorecard   scorecard @relation(fields: [scorecardId], references: [id], onDelete: Cascade)
  sections    scorecardSection[]
}

model scorecardSection {
  id             String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  scorecardGroupId String
  name          String
  weight        Float
  sortOrder     Int
  createdAt     DateTime @default(now())
  createdBy     String
  updatedAt     DateTime @updatedAt
  updatedBy     String

  group         scorecardGroup @relation(fields: [scorecardGroupId], references: [id], onDelete: Cascade)
  questions     scorecardQuestion[]
}

enum QuestionType {
  SCALE
  YES_NO
  // Add other types as needed
}

model scorecardQuestion {
  id             String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  scorecardSectionId String
  type           QuestionType
  description    String
  guidelines     String
  weight        Float
  requiresUpload Boolean
  sortOrder     Int
  createdAt     DateTime @default(now())
  createdBy     String
  updatedAt     DateTime @updatedAt
  updatedBy     String

  scaleMin          Int?        // Minimum value for scale (used when type is SCALE)
  scaleMax          Int?        // Maximum value for scale (used when type is SCALE)

  section       scorecardSection @relation(fields: [scorecardSectionId], references: [id], onDelete: Cascade)
}

model review {
  id             String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  resourceId     String
  phaseId        String
  submissionId   String
  scorecardId    String
  committed      Boolean @default(false)
  finalScore     Float
  initialScore   Float
  createdAt      DateTime @default(now())
  createdBy      String
  updatedAt      DateTime @updatedAt
  updatedBy      String

  scorecard      scorecard @relation(fields: [scorecardId], references: [id], onDelete: Cascade)
  reviewItems    reviewItem[]

  @@index([committed])  // Add index for the committed field
  @@index([submissionId])   // Index for submissionId field
  @@index([resourceId])     // Index for resourceId field
}

model reviewItem {
  id                 String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  reviewId           String
  scorecardQuestionId String
  uploadId           String?
  initialAnswer      String
  finalAnswer        String?
  managerComment     String?
  createdAt          DateTime @default(now())
  createdBy          String
  updatedAt          DateTime @updatedAt
  updatedBy          String

  review            review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewItemComments reviewItemComment[]
}

model reviewItemComment {
  id            String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  resourceId    String
  reviewItemId  String
  content       String
  type          ReviewItemCommentType
  sortOrder     Int @default(0)
  createdAt     DateTime @default(now())
  createdBy     String
  updatedAt     DateTime @updatedAt
  updatedBy     String

  reviewItem    reviewItem @relation(fields: [reviewItemId], references: [id], onDelete: Cascade)
  appeal        appeal?
}

enum ReviewItemCommentType {
  COMMENT
  REQUIRED
  RECOMMENDED
}

model appeal {
  id                  String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  resourceId          String
  reviewItemCommentId String  @unique  // Ensure one-to-one relationship
  content             String
  createdAt           DateTime @default(now())
  createdBy           String
  updatedAt           DateTime @updatedAt
  updatedBy           String

  reviewItemComment   reviewItemComment @relation(fields: [reviewItemCommentId], references: [id], onDelete: Cascade)  // Define fields and references here
  appealResponse      appealResponse?

  @@index([resourceId])     // Index for resourceId field
}

model appealResponse {
  id         String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  appealId   String   @unique
  resourceId String
  content    String
  success    Boolean
  createdAt  DateTime @default(now())
  createdBy  String
  updatedAt  DateTime @updatedAt
  updatedBy  String

  appeal     appeal @relation(fields: [appealId], references: [id], onDelete: Cascade)
}

model challengeResult {
  challengeId         String
  userId              String
  paymentId           String?
  submissionId        String
  oldRating           Int?
  newRating           Int?
  initialScore        Float
  finalScore          Float
  placement           Int
  rated               Boolean
  passedReview        Boolean
  validSubmission     Boolean
  pointAdjustment     Float?
  ratingOrder         Int?

  createdAt           DateTime @default(now())
  createdBy           String
  updatedAt           DateTime @updatedAt
  updatedBy           String

  @@id([challengeId, userId])
}

model contactRequest {
  id          String  @id @default(dbgenerated("nanoid()")) @db.VarChar(14)
  resourceId  String
  challengeId String   // Associated challenge
  message     String   // Markdown content
  createdAt           DateTime @default(now())
  createdBy           String
  updatedAt           DateTime @updatedAt
  updatedBy           String
}
